<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">

    <title>แอปคำนวณอายุราชการ (v4.1 - Confirm Delete)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'] },
                    colors: { 
                        brand: { 500: '#0ea5e9', 600: '#0284c7' }, 
                        accent: { 500: '#10b981', 600: '#059669' }, 
                        ai: { 500: '#8b5cf6', 600: '#7c3aed' },
                        google: { 500: '#fbbc05', 600: '#ea4335' },
                        retirement: { 500: '#f59e0b', 600: '#d97706' } 
                    },
                    animation: {
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
                        'scale-in': 'scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)',
                        'fade-in': 'fadeIn 0.3s ease-out'
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        scaleIn: { '0%': { transform: 'scale(0.9)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            -webkit-tap-highlight-color: transparent; background-color: #f1f5f9; /* slate-100 */
            height: 100dvh; width: 100vw; 
            overflow: hidden; display: flex; align-items: center; justify-content: center; 
            font-family: 'Sarabun', sans-serif; 
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        #app-shell { 
            width: 100%; height: 100%; background: #f8fafc; /* slate-50 */
            position: relative; overflow: hidden; 
            display: flex; flex-direction: column; 
        }
        @media (min-width: 768px) { 
            #app-shell { 
                max-width: 420px; height: 850px; max-height: 90dvh; border-radius: 40px; 
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3); border: 4px solid #e2e8f0; 
            } 
        }
        
        /* (ปรับปรุง) v4: Bottom Nav (สไตล์จากแอปคลังโปรเจค) */
        .bottom-nav {
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-top: 1px solid rgba(0,0,0,0.05);
            display: grid; grid-template-columns: 1fr 64px 1fr; /* 3 columns layout */
            position: relative; z-index: 50; padding: 8px 8px 0 8px;
            padding-bottom: env(safe-area-inset-bottom, 8px);
            align-items: center;
        }
        .nav-item {
            text-align: center; padding: 10px 5px; font-size: 11px; font-weight: 600; color: #64748b; 
            z-index: 2; cursor: pointer; transition: all 0.2s; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; gap: 2px;
        }
        .nav-item.active { color: #0284c7; background-color: #f0f9ff; }
        .nav-item i { font-size: 16px; line-height: 1; }
        #nav-add-btn {
            width: 56px; height: 56px; border-radius: 99px;
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 20px -5px rgba(14, 165, 233, 0.5);
            margin-bottom: 12px; /* Lift it up */
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 4px solid white;
        }
        #nav-add-btn:active { transform: scale(0.9); }

        /* Form Styles */
        .form-label { display: block; text-transform: uppercase; font-size: 11px; font-weight: 700; color: #475569; margin-bottom: 6px; letter-spacing: 0.5px; }
        .form-input, .form-textarea, .form-select { width: 100%; background: white; border: 1px solid #cbd5e1; border-radius: 12px; padding: 10px 14px; font-size: 14px; color: #1e293b; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.02); }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: #0ea5e9; box-shadow: 0 0 0 3px #bfdbfe; }
        .form-input[type="number"] { text-align: center; }
        .form-input::placeholder { color: #94a3b8; }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 12px 20px; border-radius: 14px; font-size: 14px; font-weight: 600; transition: all 0.2s; cursor: pointer; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .btn-primary { background-color: #0ea5e9; color: white; }
        .btn-primary:hover { background-color: #0284c7; }
        .btn-secondary { background-color: #e2e8f0; color: #334155; }
        .btn-secondary:hover { background-color: #cbd5e1; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* (ใหม่) v4: Modal Styles */
        .modal-backdrop {
            position: fixed; inset: 0; z-index: 1000;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease-out;
        }
        .modal-container {
            position: fixed; z-index: 1001;
            bottom: 0; left: 0; right: 0;
            background-color: #f8fafc;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            padding: 24px;
            padding-bottom: calc(env(safe-area-inset-bottom, 0) + 24px);
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 85vh;
            overflow-y: auto;
        }
        .modal-close-btn {
            position: absolute; top: 16px; right: 16px;
            width: 32px; height: 32px; border-radius: 99px;
            background-color: #e2e8f0; color: #64748b;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        @media (min-width: 768px) {
            .modal-container {
                left: 50%; bottom: auto; top: 50%;
                transform: translate(-50%, -50%);
                max-width: 420px; width: 100%;
                border-radius: 24px;
                animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            }
        }

        /* (ย้ายมา) v4: Result Display */
        .result-card {
            background: linear-gradient(135deg, #0284c7, #0ea5e9);
            color: white; padding: 20px; border-radius: 20px;
        }
        .retirement-card {
             background: linear-gradient(135deg, #d97706, #f59e0b);
             color: white; padding: 20px; border-radius: 20px;
        }
        .retirement-grid {
            display: grid; grid-template-columns: 1fr; gap: 12px;
        }
        @media (min-width: 380px) {
             .retirement-grid { grid-template-columns: 1fr 1fr; }
        }
        .retirement-section { text-align: center; }
        .retirement-label {
            font-size: 1rem; opacity: 0.9; font-weight: 600;
        }
        .retirement-value {
            font-size: 1.3rem; font-weight: 700; color: #fff; margin-top: 2px;
        }

        .result-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .result-row:last-child { border-bottom: none; }
        .result-label { font-weight: 400; opacity: 0.9; }
        .result-value { font-weight: 700; font-size: 1.1rem; }
        .result-total .result-label { font-size: 1.1rem; opacity: 1; }
        .result-total .result-value { font-size: 1.5rem; color: #f0f9ff; }
        
        .result-context {
            font-size: 0.75rem; /* 12px */ text-align: center; opacity: 0.8;
            margin-top: 12px; padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* (ย้ายมา) v4: <details> (ซ่อน/แสดง) */
        details {
            background-color: #f8fafc; /* slate-50 */ border-radius: 16px;
        }
        details summary {
            font-size: 1rem; font-weight: 600; color: #475569;
            padding: 16px; cursor: pointer; list-style: none; 
        }
        details summary::-webkit-details-marker { display: none; }
        details summary::before {
            content: '\f078'; font-family: 'Font Awesome 6 Free'; font-weight: 900;
            margin-right: 10px; font-size: 0.8em; transition: transform 0.2s; display: inline-block;
        }
        details[open] summary::before { transform: rotate(-180deg); }
        .details-content { padding: 0px 20px 20px 20px; }

        /* (ปรับปรุง) v4: Saved List Item (เหมือนแอปคลังโปรเจค) */
        .saved-item-card {
            background-color: white;
            padding: 16px;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.03);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .saved-item-icon {
            width: 44px; height: 44px; border-radius: 99px;
            background-color: #f0f9ff; /* sky-50 */
            color: #0284c7; /* brand-600 */
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; font-size: 18px;
        }
        .saved-item-content { flex: 1; min-width: 0; }
        .saved-item-content h4 {
            font-weight: 600; color: #1e293b; truncate;
        }
        .saved-item-content p {
            font-size: 12px; color: #64748b; truncate;
        }
        .saved-item-actions {
            display: flex; gap: 8px;
        }
        .saved-item-btn {
            width: 36px; height: 36px; border-radius: 99px;
            display: flex; align-items: center; justify-content: center;
            background-color: #f1f5f9; /* slate-100 */
            color: #475569;
            transition: all 0.2s;
        }
        .saved-item-btn:hover { background-color: #e2e8f0; }
        .saved-item-btn.delete:hover { background-color: #fee2e2; color: #dc2626; }

        
        /* Instructions Box (จากแอปตารางเวร) */
        .instructions-box { background-color: #f1f5f9; border-radius: 8px; padding: 12px; font-size: 13px; color: #475569; }
        .instructions-box code { background-color: #e2e8f0; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
        .instructions-box ol { list-style: decimal; padding-left: 20px; margin-top: 8px; }
        .instructions-box summary { font-weight: 600; cursor: pointer; }
    </style>
</head>
<body>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 z-[6000] opacity-0 pointer-events-none transition-all duration-300 translate-y[-20px] bg-slate-800/95 text-white px-5 py-3 rounded-full shadow-xl backdrop-blur-md flex items-center gap-3 text-sm font-medium border border-slate-700/50">
        <i id="toast-icon" class="fa-solid fa-check-circle text-emerald-400"></i>
        <span id="toast-msg">สำเร็จ</span>
    </div>

    <!-- File Inputs (สำหรับ Import) -->
    <input type="file" id="import-file-input" class="hidden" accept=".json, .txt" onchange="window.handleFileImport(event)">

    <!-- (ใหม่) v4: Modal สำหรับ "เพิ่ม / แก้ไข" -->
    <div id="add-edit-modal-container" class="hidden">
        <div class="modal-backdrop" onclick="window.hideAddEditModal()"></div>
        <div class="modal-container">
            <button onclick="window.hideAddEditModal()" class="modal-close-btn"><i class="fa-solid fa-times"></i></button>
            <h3 id="modal-title" class="text-xl font-bold text-slate-800 mb-6">...</h3>
            
            <form id="add-edit-form" onsubmit="window.handleSave(event); return false;" class="space-y-4">
                <input type="hidden" id="form-edit-id">
                
                <!-- ข้อมูลหลัก -->
                <div class="bg-white p-5 rounded-2xl border border-slate-200">
                    <h3 class="text-base font-bold text-slate-700 mb-4">ข้อมูลหลัก</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="form-name" class="form-label">ชื่อ-สกุล (สำหรับบันทึก)</label>
                            <input type="text" id="form-name" class="form-input" placeholder="เช่น นายสมชาย ใจดี" required>
                        </div>
                        <div>
                            <label for="form-birth-date" class="form-label">วันเกิด (สำหรับคำนวณเกษียณ)</label>
                            <input type="date" id="form-birth-date" class="form-input">
                        </div>
                        <div>
                            <label for="form-start-date" class="form-label">วันที่บรรจุ</label>
                            <input type="date" id="form-start-date" class="form-input" required>
                        </div>
                    </div>
                </div>
                
                <!-- หักวันลา -->
                <details class="border border-slate-200">
                    <summary>ขั้นสูง: หักวันลา (ที่ไม่นับอายุ)</summary>
                    <div class="details-content grid grid-cols-3 gap-3">
                        <div>
                            <label for="form-leave-y" class="form-label">ปี</label>
                            <input type="number" id="form-leave-y" class="form-input" min="0" placeholder="0">
                        </div>
                        <div>
                            <label for="form-leave-m" class="form-label">เดือน</label>
                            <input type="number" id="form-leave-m" class="form-input" min="0" placeholder="0">
                        </div>
                        <div>
                            <label for="form-leave-d" class="form-label">วัน</label>
                            <input type="number" id="form-leave-d" class="form-input" min="0" placeholder="0">
                        </div>
                    </div>
                </details>
                
                <!-- เพิ่มวันทวีคูณ -->
                <details class="border border-slate-200">
                    <summary>ขั้นสูง: เพิ่มวันทวีคูณ</summary>
                    <div class="details-content grid grid-cols-3 gap-3">
                        <div>
                            <label for="form-mult-y" class="form-label">ปี</label>
                            <input type="number" id="form-mult-y" class="form-input" min="0" placeholder="0">
                        </div>
                        <div>
                            <label for="form-mult-m" class="form-label">เดือน</label>
                            <input type="number" id="form-mult-m" class="form-input" min="0" placeholder="0">
                        </div>
                        <div>
                            <label for="form-mult-d" class="form-label">วัน</label>
                            <input type="number" id="form-mult-d" class="form-input" min="0" placeholder="0">
                        </div>
                    </div>
                </details>

                <!-- Button -->
                <div class="pt-4">
                    <button type="submit" class="btn btn-primary w-full">
                        <i class="fa-solid fa-save mr-2"></i> บันทึกข้อมูล
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- (ใหม่) v4: Modal สำหรับ "แสดงผลลัพธ์" -->
    <div id="result-modal-container" class="hidden">
        <div class="modal-backdrop" onclick="window.hideResultModal()"></div>
        <div class="modal-container">
            <button onclick="window.hideResultModal()" class="modal-close-btn"><i class="fa-solid fa-times"></i></button>
            <h3 id="result-modal-title" class="text-xl font-bold text-slate-800 mb-6">...</h3>
            
            <div class="space-y-4">
                <!-- Retirement Card -->
                <div id="retirement-card" class="retirement-card">
                    <div class="retirement-grid">
                        <div class="retirement-section">
                            <div class="retirement-label">วันเกษียณอายุ</div>
                            <div id="retirement-date-result" class="retirement-value">...</div>
                        </div>
                        <div class="retirement-section">
                            <div class="retirement-label">เหลือเวลาอีก</div>
                            <div id="retirement-countdown-result" class="retirement-value">...</div>
                        </div>
                    </div>
                </div>

                <!-- Result Card -->
                <div id="result-container" class="result-card">
                    <div class="result-row">
                        <span class="result-label">อายุราชการ (ดิบ)</span>
                        <span id="result-raw" class="result-value">...</span>
                    </div>
                    <div id="result-row-leave" class="result-row hidden">
                        <span class="result-label">หักวันลา</span>
                        <span id="result-leave" class="result-value">...</span>
                    </div>
                    <div id="result-row-mult" class="result-row hidden">
                        <span class="result-label">บวกวันทวีคูณ</span>
                        <span id="result-mult" class="result-value">...</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">รวม (วัน)</span>
                        <span id="result-total-days" class="result-value">...</span>
                    </div>
                    <div class="result-row result-total mt-2 pt-2">
                        <span class="result-label">อายุราชการสุทธิ</span>
                        <span id="result-net" class="result-value">...</span>
                    </div>
                    <div class="result-context">
                        <span id="result-context-dates">...</span>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- (ปรับปรุง) v4.1: Modal สำหรับ "ยืนยันการลบ" -->
    <div id="delete-modal-container" class="hidden">
        <div class="modal-backdrop" onclick="window.hideDeleteModal()"></div>
        <div class="modal-container">
            <button onclick="window.hideDeleteModal()" class="modal-close-btn"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-xl font-bold text-slate-800 mb-4">
                <i class="fa-solid fa-triangle-exclamation text-amber-500 mr-2"></i> ยืนยันการลบ
            </h3>
            <p id="delete-modal-text" class="text-slate-600 mb-6">คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้?</p>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="window.hideDeleteModal()" class="btn btn-secondary">
                    <i class="fa-solid fa-times mr-2"></i> ยกเลิก
                </button>
                <button onclick="window.confirmDelete()" class="btn btn-danger">
                    <i class="fa-solid fa-trash mr-2"></i> ลบ
                </button>
            </div>
        </div>
    </div>


    <main id="app-shell">

        <!-- Header -->
        <header class="px-6 py-4 flex justify-between items-center sticky top-0 shadow-sm bg-white/80 z-40 backdrop-filter: blur(12px) border-b border-slate-100/80">
            <div class="flex flex-col">
                <h1 class="text-xl font-bold text-brand-600">คำนวณอายุราชการ</h1>
                <p id="header-subtitle" class="text-sm text-slate-500">v4.1 - Confirm Delete</p>
            </div>
            <div id="header-icon-container" class="w-12 h-12 bg-sky-100 rounded-full flex items-center justify-center text-sky-600 border-4 border-white shadow-md">
                <i id="header-icon" class="fa-solid fa-list-check text-xl"></i>
            </div>
        </header>

        <div id="content-area" class="flex-1 overflow-y-auto no-scrollbar pb-6">
            
            <!-- (ปรับปรุง) v4: View 1: Saved List (หน้าหลัก) -->
            <section id="view-saved" class="p-6 space-y-4">
                <div class="relative">
                    <input type="text" id="input-search" oninput="window.renderSavedList()" class="form-input pl-10" placeholder="ค้นหาชื่อ...">
                    <i class="fa-solid fa-search text-slate-400 absolute top-1/2 left-3.5 -translate-y-1/2"></i>
                </div>
                <div id="saved-list-container" class="space-y-3">
                    <!-- JS populates this -->
                </div>
            </section>
            
            <!-- (ปรับปรุง) v4: View 2: Manage / Settings (ซ่อนไว้) -->
            <section id="view-manage" class="hidden p-6 space-y-6">
                
                <!-- Google Sheet Sync -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-700">Google Sheet Sync</h3>
                        <i class="fa-brands fa-google-drive text-2xl text-google-500"></i>
                    </div>
                    <div>
                        <label for="input-apps-script-url" class="form-label">Google Apps Script URL</label>
                        <input type="url" id="input-apps-script-url" class="form-input" placeholder="https://script.google.com/macros/s/..." oninput="window.saveAppsScriptUrl(this.value)">
                    </div>
                    <p class="text-sm text-slate-600 mt-4 p-3 bg-green-50 rounded-lg border border-green-200">
                        <i class="fa-solid fa-circle-info mr-1 text-green-600"></i>
                        ระบบจะ Sync อัตโนมัติเมื่อมีการบันทึก, แก้ไข, หรือลบข้อมูล
                    </p>

                    <details class="mt-4">
                        <summary class="instructions-box summary">
                            <i class="fa-solid fa-info-circle"></i> วิธีรับ URL (คลิกเพื่ออ่าน)
                        </summary>
                        <div class="instructions-box mt-2 space-y-2">
                            <ol class="space-y-1 list-decimal list-inside">
                                <li>ไปที่ <code>sheets.new</code> &gt; <code>ส่วนขยาย &gt; Apps Script</code></li>
                                <li>วางโค้ด (v2) จากช่องถัดไป</li>
                                <li><code>Deploy &gt; New deployment &gt; Web app</code></li>
                                <li>ตั้งค่า "Who has access" เป็น <code>Anyone</code></li>
                                <li>กด Deploy, อนุญาตสิทธิ์, และคัดลอก URL มาวาง</li>
                            </ol>
                        </div>
                    </details>
                    <details class="mt-2">
                         <summary class="instructions-box summary">
                            <i class="fa-solid fa-code"></i> โค้ดสำหรับ Apps Script (Code.gs) (v2 - Dynamic)
                        </summary>
                        <div class="instructions-box mt-2">
                            <pre class="overflow-x-auto p-2 bg-slate-700 text-white rounded-md text-xs"><code>function doPost(e) {
  try {
    var sheetName = "ServiceYears"; // ตั้งชื่อ Sheet
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName(sheetName);
    if (!sheet) {
      sheet = ss.insertSheet(sheetName);
    }
    
    var data = JSON.parse(e.postData.contents);
    
    if (data.length === 0) {
      sheet.clearContents();
      sheet.getRange(1, 1).setValue("No data synced.");
      return ContentService.createTextOutput(JSON.stringify({ status: "success", message: "Data was empty, sheet cleared." })).setMimeType(ContentService.MimeType.JSON);
    }

    var headers = Object.keys(data[0]);
    var values = data.map(function(row) {
      return headers.map(function(header) {
        return row[header] !== undefined ? row[header] : "";
      });
    });

    sheet.clearContents();
    
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight("bold");
    
    if (values.length > 0) {
      sheet.getRange(2, 1, values.length, headers.length).setValues(values);
      sheet.autoResizeColumns(1, headers.length);
    }
    
    return ContentService.createTextOutput(JSON.stringify({ status: "success", rows_synced: values.length, sheetName: sheetName })).setMimeType(ContentService.MimeType.JSON);
  
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ status: "error", message: error.message })).setMimeType(ContentService.MimeType.JSON);
  }
}</code></pre>
                        </div>
                    </details>
                </div>
                
                <!-- Import/Export -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-bold text-slate-700 mb-4">นำเข้า / ส่งออก ข้อมูล</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="window.exportBackup()" class="btn btn-secondary">
                            <i class="fa-solid fa-download mr-2"></i> บันทึกลงเครื่อง
                        </button>
                        <button onclick="window.triggerImport()" class="btn btn-secondary">
                            <i class="fa-solid fa-upload mr-2"></i> นำเข้าจากเครื่อง
                        </button>
                    </div>
                </div>

                <!-- JSON Data -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-bold text-slate-700 mb-4">จัดการข้อมูล (JSON)</h3>
                    <div>
                        <label for="input-data-json" class="form-label">ข้อมูลที่บันทึกไว้ (JSON Array)</label>
                        <textarea id="input-data-json" class="form-textarea" rows="8"></textarea>
                    </div>
                    <button onclick="window.saveDataFromJson()" class="btn btn-secondary w-full mt-4">
                        <i class="fa-solid fa-save mr-2"></i> บันทึกข้อมูล
                    </button>
                </div>
            </section>

        </div>

        <!-- (ปรับปรุง) v4: Bottom Nav (3 ปุ่ม) -->
        <nav id="bottom-nav" class="bottom-nav shrink-0">
            <div id="nav-saved" class="nav-item active" onclick="window.switchView('view-saved')">
                <i class="fa-solid fa-list-check"></i>
                <span>รายการ</span>
            </div>
            
            <div class="flex items-center justify-center">
                 <button id="nav-add-btn" onclick="window.showAddModal()">
                    <i class="fa-solid fa-plus text-lg"></i>
                </button>
            </div>
           
            <div id="nav-manage" class="nav-item" onclick="window.switchView('view-manage')">
                <i class="fa-solid fa-sliders"></i>
                <span>ตั้งค่า</span>
            </div>
        </nav>
    </main>

    <script type="module">
        
        // --- CONSTANTS ---
        const DAYS_PER_MONTH = 30;
        const DAYS_PER_YEAR = 365; 
        const LOCAL_STORAGE_KEY = 'service_year_data_v1';
        const GAS_URL_KEY = 'service_year_gas_url_v1';

        // --- STATE & DOM ---
        let state = {
            savedCalculations: [],
            currentView: 'view-saved', // (ใหม่) v4: เริ่มที่หน้า List
            editingId: null,
            idToDelete: null // (ปรับปรุง) v4.1: สำหรับเก็บ ID ที่รอยืนยันลบ
        };
        
        const dom = {
            views: { 
                saved: document.getElementById('view-saved'), 
                manage: document.getElementById('view-manage') 
            },
            nav: { 
                saved: document.getElementById('nav-saved'), 
                manage: document.getElementById('nav-manage') 
            },
            headerSubtitle: document.getElementById('header-subtitle'),
            headerIcon: document.getElementById('header-icon'),
            
            // Add/Edit Modal
            addEditModalContainer: document.getElementById('add-edit-modal-container'),
            modalTitle: document.getElementById('modal-title'),
            addEditForm: document.getElementById('add-edit-form'),
            formEditId: document.getElementById('form-edit-id'),
            formName: document.getElementById('form-name'),
            formBirthDate: document.getElementById('form-birth-date'), 
            formStartDate: document.getElementById('form-start-date'),
            formLeaveY: document.getElementById('form-leave-y'),
            formLeaveM: document.getElementById('form-leave-m'),
            formLeaveD: document.getElementById('form-leave-d'),
            formMultY: document.getElementById('form-mult-y'),
            formMultM: document.getElementById('form-mult-m'),
            formMultD: document.getElementById('form-mult-d'),

            // Result Modal
            resultModalContainer: document.getElementById('result-modal-container'),
            resultModalTitle: document.getElementById('result-modal-title'),
            retirementCard: document.getElementById('retirement-card'), 
            retirementDateResult: document.getElementById('retirement-date-result'), 
            retirementCountdownResult: document.getElementById('retirement-countdown-result'), 
            resultContainer: document.getElementById('result-container'),
            resultRaw: document.getElementById('result-raw'),
            resultLeave: document.getElementById('result-leave'),
            resultMult: document.getElementById('result-mult'),
            resultNet: document.getElementById('result-net'),
            resultRowLeave: document.getElementById('result-row-leave'), 
            resultRowMult: document.getElementById('result-row-mult'), 
            resultTotalDays: document.getElementById('result-total-days'), 
            resultContextDates: document.getElementById('result-context-dates'), 

            // (ปรับปรุง) v4.1: Delete Modal
            deleteModalContainer: document.getElementById('delete-modal-container'),
            deleteModalText: document.getElementById('delete-modal-text'),

            // View Saved
            inputSearch: document.getElementById('input-search'),
            savedListContainer: document.getElementById('saved-list-container'),
            
            // View Manage
            inputAppsScriptUrl: document.getElementById('input-apps-script-url'),
            importFileInput: document.getElementById('import-file-input'),
            inputDataJson: document.getElementById('input-data-json'),

            // Toast
            toast: document.getElementById('toast'),
            toastIcon: document.getElementById('toast-icon'),
            toastMsg: document.getElementById('toast-msg'),
        };

        // --- INITIALIZATION ---
        function initApp() {
            loadCalculations();
            loadAppsScriptUrl(); 
            switchView('view-saved'); // (ใหม่) v4: เริ่มที่หน้านี้
        }

        // --- NAVIGATION & UTILS ---
        
        function switchView(id) {
            state.currentView = id;

            Object.values(dom.views).forEach(el => el.classList.add('hidden'));
            const viewId = id.split('-')[1]; 
            if (dom.views[viewId]) dom.views[viewId].classList.remove('hidden');
            
            Object.values(dom.nav).forEach(el => el.classList.remove('active'));
            if (dom.nav[viewId]) dom.nav[viewId].classList.add('active');
            
            updateHeader(id);
            
            switch(id) {
                case 'view-saved': renderSavedList(); break;
                case 'view-manage': renderManage(); break;
            }
        }

        function updateHeader(id) {
            let subtitle = "รายการที่บันทึกไว้";
            let iconClass = "fa-solid fa-list-check";

            switch(id) {
                case 'view-manage':
                    subtitle = "ตั้งค่า & จัดการข้อมูล";
                    iconClass = "fa-solid fa-sliders";
                    break;
            }
            
            dom.headerSubtitle.textContent = subtitle;
            dom.headerIcon.className = `${iconClass} text-xl`;
        }

        function showToast(msg, type='success') {
            dom.toastMsg.textContent = msg;
            dom.toastIcon.className = type==='success' ? "fa-solid fa-circle-check text-emerald-400" : "fa-solid fa-circle-exclamation text-rose-400";
            dom.toast.classList.remove('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => dom.toast.classList.add('opacity-0', 'translate-y-[-20px]'), 3000);
        }

        // --- DATA PERSISTENCE (LocalStorage) ---
        
        function loadCalculations() {
            const data = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (data) {
                try { state.savedCalculations = JSON.parse(data); } catch (e) { state.savedCalculations = []; }
            } else {
                state.savedCalculations = [];
            }
        }
        
        function saveCalculationsToStorage() {
            try {
                // (ปรับปรุง) v4: ไม่เก็บผลลัพธ์ที่คำนวณแล้ว (endDate, netResult, netDays)
                // เราจะเก็บเฉพาะ "ข้อมูลดิบ" (Raw Data)
                const dataToSave = state.savedCalculations.map(item => ({
                    id: item.id,
                    name: item.name,
                    birthDate: item.birthDate, 
                    startDate: item.startDate,
                    leave: item.leave,
                    mult: item.mult
                }));
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
            } catch (e) { showToast('ไม่สามารถบันทึกข้อมูลได้ (อาจจะเต็ม)', 'error'); }
        }

        function loadAppsScriptUrl() {
            const url = localStorage.getItem(GAS_URL_KEY);
            if (url) dom.inputAppsScriptUrl.value = url;
        }
        
        // --- CORE CALCULATION LOGIC ---
        // (ฟังก์ชัน 4 ตัวนี้เหมือน v3 ทุกประการ)

        function calculateDifference(d1, d2) {
            if (d2 < d1) return { y: 0, m: 0, d: 0 };
            let y = d2.getFullYear() - d1.getFullYear();
            let m = d2.getMonth() - d1.getMonth();
            let d = d2.getDate() - d1.getDate();
            if (d < 0) {
                m--;
                let lastMonthDate = new Date(d2.getFullYear(), d2.getMonth(), 0);
                d += lastMonthDate.getDate();
            }
            if (m < 0) {
                y--;
                m += 12;
            }
            return { y, m, d };
        }

        function ymdToDays(ymd) {
            return (ymd.y * DAYS_PER_YEAR) + (ymd.m * DAYS_PER_MONTH) + ymd.d;
        }

        function daysToYmd(totalDays) {
            totalDays = Math.max(0, totalDays); 
            const y = Math.floor(totalDays / DAYS_PER_YEAR);
            const remainder = totalDays % DAYS_PER_YEAR;
            const m = Math.floor(remainder / DAYS_PER_MONTH);
            const d = remainder % DAYS_PER_MONTH;
            return { y, m, d };
        }
        
        function formatYmd(ymd) {
            return `${ymd.y} ปี ${ymd.m} เดือน ${ymd.d} วัน`;
        }
        
        function calculateRetirementDate(birthDateStr) {
            if (!birthDateStr) return null;
            try {
                const birthDate = new Date(birthDateStr);
                let retirementYear = birthDate.getFullYear() + 60;
                const birthMonth = birthDate.getMonth(); 
                if (birthMonth >= 9) { // 9 คือ ต.ค. (0-indexed)
                    retirementYear++;
                }
                const retirementDate = new Date(retirementYear, 8, 30); // 8 คือ ก.ย.
                return retirementDate; 
            } catch (e) {
                console.error("Error calculating retirement:", e);
                return null;
            }
        }

        // --- (ใหม่) v4: MODAL HANDLERS ---
        
        function showAddModal() {
            state.editingId = null;
            dom.modalTitle.textContent = "เพิ่มรายการใหม่";
            dom.addEditForm.reset();
            // เปิด <details> ที่ซ่อนไว้ (ถ้ามี)
            dom.addEditForm.querySelectorAll('details').forEach(d => d.open = false);
            dom.addEditModalContainer.classList.remove('hidden');
        }

        function hideAddEditModal() {
            dom.addEditModalContainer.classList.add('hidden');
        }
        
        function showResultModal(id) {
            const item = state.savedCalculations.find(i => i.id === id);
            if (!item) return;

            // --- นี่คือหัวใจของ v4: คำนวณสด ---
            const d1 = new Date(item.startDate);
            const d2 = new Date(); // ใช้ "วันนี้" เป็นวันที่คำนวณ
            
            // 1. คำนวณเกษียณ
            const retirementDateObj = calculateRetirementDate(item.birthDate);
            if (retirementDateObj) {
                dom.retirementDateResult.textContent = retirementDateObj.toLocaleDateString('th-TH', {
                    day: 'numeric', month: 'long', year: 'numeric'
                });
                
                if (retirementDateObj > d2) {
                    const countdownYmd = calculateDifference(d2, retirementDateObj);
                    dom.retirementCountdownResult.textContent = formatYmd(countdownYmd);
                } else {
                    dom.retirementCountdownResult.textContent = "เกษียณแล้ว";
                }
                dom.retirementCard.classList.remove('hidden');
            } else {
                dom.retirementCard.classList.add('hidden');
            }

            // 2. คำนวณอายุราชการ
            const rawYmd = calculateDifference(d1, d2);
            const rawDays = ymdToDays(rawYmd);
            const leaveDays = ymdToDays(item.leave || {y:0,m:0,d:0});
            const multDays = ymdToDays(item.mult || {y:0,m:0,d:0});
            const netDays = rawDays - leaveDays + multDays;
            const netYmd = daysToYmd(netDays);
            
            // 3. Render Results
            dom.resultModalTitle.textContent = item.name;
            dom.resultRaw.textContent = formatYmd(rawYmd);
            dom.resultNet.textContent = formatYmd(netYmd);
            dom.resultTotalDays.textContent = netDays.toLocaleString() + ' วัน';
            
            const d1_formatted = d1.toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: 'numeric' });
            const d2_formatted = d2.toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: 'numeric' });
            dom.resultContextDates.textContent = `บรรจุ: ${d1_formatted} | คำนวณถึง: ${d2_formatted} (วันนี้)`;
            
            if(leaveDays > 0) {
                dom.resultLeave.textContent = "- " + formatYmd(item.leave);
                dom.resultRowLeave.classList.remove('hidden');
            } else {
                dom.resultRowLeave.classList.add('hidden');
            }
            if(multDays > 0) {
                dom.resultMult.textContent = "+ " + formatYmd(item.mult);
                dom.resultRowMult.classList.remove('hidden');
            } else {
                dom.resultRowMult.classList.add('hidden');
            }
            
            dom.resultContainer.classList.remove('hidden');
            dom.resultModalContainer.classList.remove('hidden');
        }
        
        function hideResultModal() {
            dom.resultModalContainer.classList.add('hidden');
        }

        // --- (ปรับปรุง) v4.1: EVENT HANDLERS ---

        function handleSave(event) {
            event.preventDefault();
            
            const record = {
                id: state.editingId || `calc_${Date.now()}`,
                name: dom.formName.value,
                birthDate: dom.formBirthDate.value || null, 
                startDate: dom.formStartDate.value,
                leave: {
                    y: parseInt(dom.formLeaveY.value) || 0,
                    m: parseInt(dom.formLeaveM.value) || 0,
                    d: parseInt(dom.formLeaveD.value) || 0,
                },
                mult: {
                    y: parseInt(dom.formMultY.value) || 0,
                    m: parseInt(dom.formMultM.value) || 0,
                    d: parseInt(dom.formMultD.value) || 0,
                }
            };
            
            if (state.editingId) {
                // Update
                state.savedCalculations = state.savedCalculations.map(item => 
                    item.id === state.editingId ? record : item
                );
            } else {
                // Add new
                state.savedCalculations.push(record);
            }

            saveCalculationsToStorage();
            triggerAutoSync();
            
            showToast(`บันทึกข้อมูล '${record.name}' สำเร็จ`);
            
            hideAddEditModal();
            renderSavedList();

            // (ปรับปรุง) v4.2: แสดงผลลัพธ์ทันทีหลังจากบันทึก
            window.showResultModal(record.id);
        }

        function renderSavedList() {
            const searchTerm = dom.inputSearch.value.toLowerCase();
            const list = state.savedCalculations.filter(item => 
                item.name.toLowerCase().includes(searchTerm)
            );

            if (list.length === 0) {
                dom.savedListContainer.innerHTML = `
                <div class="text-center text-slate-500 mt-10 p-4 animate-fade-in">
                    <i class="fa-solid fa-users text-4xl text-slate-300 mb-4"></i>
                    <p class="font-semibold">ไม่พบรายการที่บันทึกไว้</p>
                    <p>กดปุ่ม <i class="fa-solid fa-plus-circle text-brand-500"></i> ตรงกลางด้านล่างเพื่อเพิ่ม</p>
                </div>`;
                return;
            }
            
            list.sort((a, b) => (a.name || "").localeCompare(b.name));

            dom.savedListContainer.innerHTML = list.map(item => `
                <div class="saved-item-card animate-fade-in">
                    <div class="saved-item-icon">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <div class="saved-item-content cursor-pointer" onclick="window.showResultModal('${item.id}')">
                        <h4>${item.name}</h4>
                        <p>บรรจุ: ${item.startDate}</p>
                    </div>
                    <div class="saved-item-actions">
                        <button onclick="window.handleEdit('${item.id}')" class="saved-item-btn">
                            <i class="fa-solid fa-pencil text-sm"></i>
                        </button>
                        <button onclick="window.handleDelete('${item.id}')" class="saved-item-btn delete">
                            <i class="fa-solid fa-trash text-sm"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function handleEdit(id) {
            const item = state.savedCalculations.find(i => i.id === id);
            if (!item) return;

            state.editingId = id;
            
            dom.modalTitle.textContent = "แก้ไขรายการ";
            dom.formEditId.value = item.id;
            dom.formName.value = item.name;
            dom.formBirthDate.value = item.birthDate || ''; 
            dom.formStartDate.value = item.startDate;
            dom.formLeaveY.value = item.leave?.y || '';
            dom.formLeaveM.value = item.leave?.m || '';
            dom.formLeaveD.value = item.leave?.d || '';
            dom.formMultY.value = item.mult?.y || '';
            dom.formMultM.value = item.mult?.m || '';
            dom.formMultD.value = item.mult?.d || '';
            
            if(item.leave?.y || item.leave?.m || item.leave?.d) {
                dom.formLeaveY.closest('details').open = true;
            }
            if(item.mult?.y || item.mult?.m || item.mult?.d) {
                dom.formMultY.closest('details').open = true;
            }

            dom.addEditModalContainer.classList.remove('hidden');
        }

        // (ปรับปรุง) v4.1: เปลี่ยน handleDelete ให้แสดง Modal ยืนยัน
        function handleDelete(id) {
            const item = state.savedCalculations.find(i => i.id === id);
            if (!item) return;

            state.idToDelete = id;
            dom.deleteModalText.innerHTML = `คุณแน่ใจหรือไม่ว่าต้องการลบ<br><strong class="text-slate-800">'${item.name}'</strong>?`;
            dom.deleteModalContainer.classList.remove('hidden');
        }

        // (ปรับปรุง) v4.1: ฟังก์ชันใหม่สำหรับซ่อน Modal ยืนยันลบ
        function hideDeleteModal() {
            state.idToDelete = null;
            dom.deleteModalContainer.classList.add('hidden');
        }

        // (ปรับปรุง) v4.1: ฟังก์ชันใหม่สำหรับยืนยันการลบ (ทำงานจริง)
        function confirmDelete() {
            if (!state.idToDelete) return;

            const item = state.savedCalculations.find(i => i.id === state.idToDelete);
            const itemName = item ? item.name : 'รายการ';

            state.savedCalculations = state.savedCalculations.filter(i => i.id !== state.idToDelete);
            
            saveCalculationsToStorage();
            triggerAutoSync();
            renderSavedList();
            hideDeleteModal();
            showToast(`ลบรายการ '${itemName}' แล้ว`, 'success');
        }

        function renderManage() {
            dom.inputDataJson.value = JSON.stringify(state.savedCalculations, null, 2);
            loadAppsScriptUrl();
        }

        // --- MANAGE VIEW FUNCTIONS ---

        function saveDataFromJson() {
            try {
                const newData = JSON.parse(dom.inputDataJson.value);
                if (Array.isArray(newData)) {
                    state.savedCalculations = newData;
                    saveCalculationsToStorage();
                    showToast('บันทึกข้อมูล JSON สำเร็จ');
                    renderSavedList();
                    triggerAutoSync();
                } else { showToast('รูปแบบข้อมูลไม่ถูกต้อง (ต้องเป็น Array)', 'error'); }
            } catch (e) { showToast(`เกิดข้อผิดพลาด: ${e.message}`, 'error'); }
        }

        function exportBackup() {
            const data = JSON.stringify(state.savedCalculations, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `service_year_backup_${new Date().toLocaleDateString('sv-SE')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('กำลังดาวน์โหลดไฟล์สำรองข้อมูล');
        }
        
        function triggerImport() { dom.importFileInput.click(); }
        
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (Array.isArray(importedData)) {
                            state.savedCalculations = importedData;
                        } else {
                            throw new Error('ไฟล์ไม่ถูกต้อง (ต้องเป็น Array)');
                        }

                        saveCalculationsToStorage();
                        renderSavedList();
                        renderManage(); 
                        switchView('view-saved'); 
                        triggerAutoSync();
                    } catch (err) { showToast(`เกิดข้อผิดพลาด: ${err.message}`, 'error'); }
                };
                reader.readText(file);
            }
            event.target.value = null; 
        }

        // --- GOOGLE SHEET SYNC (Auto) ---
        
        async function triggerAutoSync() {
            const url = dom.inputAppsScriptUrl.value;
            if (!url) return; 

            console.log("Auto-syncing to Google Sheet in background...");

            try {
                const payload = JSON.stringify(state.savedCalculations);
                const response = await fetch(url, {
                    method: 'POST', mode: 'cors', 
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: payload
                });
                const result = await response.json();
                if (result.status === 'success') {
                    console.log(`Auto-sync successful: ${result.rows_synced} rows.`);
                } else {
                    throw new Error(result.message || "Unknown error from Apps Script");
                }
            } catch (error) {
                console.error("GSheet Auto-Sync Error:", error);
                showToast(`Auto-sync ล้มเหลว: ${error.message}`, 'error');
            }
        }


        // --- Window Attachments ---
        window.switchView = switchView;
        window.showAddModal = showAddModal;
        window.hideAddEditModal = hideAddEditModal;
        window.showResultModal = showResultModal;
        window.hideResultModal = hideResultModal;
        window.handleSave = handleSave;
        window.handleEdit = handleEdit;
        window.handleDelete = handleDelete; // (ปรับปรุง) v4.1: ชี้ไปที่ฟังก์ชันใหม่
        window.hideDeleteModal = hideDeleteModal; // (ปรับปรุง) v4.1: เพิ่มใหม่
        window.confirmDelete = confirmDelete; // (ปรับปรุง) v4.1: เพิ่มใหม่
        window.renderSavedList = renderSavedList;
        window.saveAppsScriptUrl = (v) => { localStorage.setItem(GAS_URL_KEY, v); };
        window.saveDataFromJson = saveDataFromJson;
        window.exportBackup = exportBackup;
        window.triggerImport = triggerImport;
        window.handleFileImport = handleFileImport;
        window.triggerAutoSync = triggerAutoSync;

        // --- Start App ---
        initApp();
    </script>
</body>
</html>
