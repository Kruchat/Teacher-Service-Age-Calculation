<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <!-- (Viewport and Meta tags) -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">

    <title>แอปคำนวณอายุราชการ (v14 - Modern AI)</title>
    
    <!-- (Scripts and Fonts) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script>
        // (Tailwind Config)
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'] },
                    colors: { 
                        brand: { 500: '#0ea5e9', 600: '#0284c7' }, 
                        accent: { 500: '#10b981', 600: '#059669' }, 
                        ai: { 500: '#8b5cf6', 600: '#7c3aed' },
                        google: { 500: '#fbbc05', 600: '#ea4335' },
                        danger: { 500: '#ef4444', 600: '#dc2626' },
                        year: { 500: '#0ea5e9', 100: '#f0f9ff' }, 
                        month: { 500: '#10b981', 100: '#f0fdf4' }, 
                        day: { 500: '#f59e0b', 100: '#fffbeb' } 
                    },
                    animation: {
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
                        'scale-in': 'scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)',
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'spin': 'spin 1s linear infinite', 
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        scaleIn: { '0%': { transform: 'scale(0.9)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        spin: { 
                            '0%': { transform: 'rotate(0deg)' },
                            '100%': { transform: 'rotate(360deg)' },
                        },
                    }
                }
            }
        }
    </script>

    <style>
        /* (Base Styles) */
        body { 
            -webkit-tap-highlight-color: transparent; background-color: #f1f5f9; /* slate-100 */
            height: 100dvh; width: 100vw; 
            overflow: hidden; display: flex; align-items: center; justify-content: center; 
            font-family: 'Sarabun', sans-serif; 
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        #app-shell { 
            width: 100%; height: 100%; background: #f8fafc; /* slate-50 */
            position: relative; overflow: hidden; 
            display: flex; flex-direction: column; 
        }
        @media (min-width: 768px) { 
            #app-shell { 
                max-width: 420px; height: 850px; max-height: 90dvh; border-radius: 40px; 
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3); border: 4px solid #e2e8f0; 
            } 
        }
        
        /* (Bottom Nav) */
        .bottom-nav {
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-top: 1px solid rgba(0,0,0,0.05);
            display: flex; position: relative; z-index: 50; padding: 8px 8px 0 8px;
            padding-bottom: env(safe-area-inset-bottom, 8px);
        }
        .nav-item {
            flex: 1; text-align: center; padding: 10px 5px; font-size: 11px; font-weight: 600; color: #64748b; /* slate-500 */
            z-index: 2; cursor: pointer; transition: color 0.2s; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; gap: 2px;
        }
        .nav-item.active { color: #0284c7; /* brand-600 */ background-color: #f0f9ff; /* sky-50 */ }
        #nav-calc.active { color: #059669; background-color: #f0fdf4; } 
        .nav-item i { font-size: 16px; line-height: 1; }

        /* (Form Styles) */
        .form-label { display: block; text-transform: uppercase; font-size: 11px; font-weight: 700; color: #475569; margin-bottom: 6px; letter-spacing: 0.5px; }
        .form-input, .form-textarea, .form-select { 
            width: 100%; background: white; border: 1px solid #cbd5e1; border-radius: 12px; padding: 10px 14px; font-size: 14px; color: #1e293b; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.02); 
            appearance: none;
            background-image: none;
            padding-right: 14px;
        }
        .form-select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 0.7rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
            padding-right: 2.5rem;
        }
        
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: #0ea5e9; box-shadow: 0 0 0 3px #bfdbfe; }
        
        .form-input[type="number"] { text-align: center; }
        .form-input::placeholder { color: #94a3b8; }
        
        .smart-date-wrapper {
            position: relative;
        }
        .smart-date-spinner {
            position: absolute;
            right: 12px;
            top: 12px;
            width: 20px;
            height: 20px;
            color: #64748b; 
        }
        .smart-date-spinner.hidden {
            display: none;
        }
        .smart-date-spinner i {
            animation: spin 1s linear infinite;
        }

        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 12px 20px; border-radius: 14px; font-size: 14px; font-weight: 600; transition: all 0.2s; cursor: pointer; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .btn-primary { background-color: #0ea5e9; color: white; }
        .btn-primary:hover { background-color: #0284c7; }
        .btn-secondary { background-color: #e2e8f0; color: #334155; }
        .btn-secondary:hover { background-color: #cbd5e1; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-ai {
            background-color: #f5f3ff; 
            color: #7c3aed; 
            border: 1px solid #ede9fe; 
            box-shadow: none;
        }
        .btn-ai:hover {
            background-color: #ede9fe; 
        }
        /* (v14) Style for Calculate Button */
        .btn-calc {
            background-color: #059669; /* accent-600 */
            color: white;
            padding: 16px 20px; /* Bigger */
            border-radius: 16px;
            font-size: 16px;
        }
        .btn-calc:hover {
            background-color: #047857; /* accent-700 */
        }
        .btn-calc.hidden {
            display: none;
        }

        /* (Modal Styles) */
        .modal-backdrop {
            position: fixed; inset: 0; z-index: 1000;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease-out;
        }
        .modal-container {
            position: fixed; z-index: 1001;
            bottom: 0; left: 0; right: 0;
            background-color: #f8fafc;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            padding: 0;
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 85vh;
            overflow-y: auto;
            overflow: hidden;
        }
        .modal-close-btn {
            position: absolute; top: 16px; right: 16px;
            width: 32px; height: 32px; border-radius: 99px;
            background-color: #e2e8f0; color: #64748b;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            z-index: 1002;
        }
        @media (min-width: 768px) {
            .modal-container {
                left: 50%; bottom: auto; top: 50%;
                transform: translate(-50%, -50%);
                max-width: 420px; width: 100%;
                border-radius: 24px;
                animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            }
        }
        
        /* (v14) Result Display Styles (Simplified) */
        .result-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 20px; /* (v14) A bit more padding */
            border-bottom: 1px solid #f1f5f9;
            background-color: white;
        }
        .result-row:last-child { border-bottom: none; }
        .result-label { font-weight: 500; color: #334155; }
        .result-value { font-weight: 600; font-size: 1rem; color: #0284c7; }
        
        /* (v14) ลบ .result-details */

        /* (v13) AI Analysis Result Box */
        #ai-analysis-container {
            padding: 16px 20px;
            background-color: #f5f3ff; 
            border-top: 1px solid #ede9fe; 
            border-bottom: 1px solid #ede9fe;
        }
        #ai-analysis-container p {
            font-size: 0.9rem;
            color: #5b21b6; 
            line-height: 1.6;
        }
        #ai-analysis-container .ai-spinner {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #7c3aed; 
        }
        #ai-analysis-container .ai-spinner i {
            animation: spin 1s linear infinite;
        }

        /* (Saved List Item Card) */
        .saved-item-card {
            display: flex;
            align-items: center;
            gap: 12px;
            background-color: white;
            padding: 16px;
            border-radius: 16px;
            border: 1px solid #e2e8f0; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.03);
            animation: fadeIn 0.3s ease-out;
        }
        .saved-item-icon {
            width: 44px; height: 44px;
            border-radius: 99px;
            background-color: #f0f9ff; 
            color: #0284c7; 
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 18px;
        }
        .saved-item-content { flex: 1; overflow: hidden; }
        .saved-item-content h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b; 
            truncate: true;
        }
        .saved-item-content p {
            font-size: 0.9rem;
            color: #475569; 
        }
        .saved-item-actions { display: flex; gap: 8px; }
        .saved-item-btn {
            width: 36px; height: 36px;
            border-radius: 99px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #64748b; 
            background-color: #f1f5f9; 
            transition: all 0.2s;
        }
        .saved-item-btn:hover { background-color: #e2e8f0; }
        .saved-item-btn.danger:hover { color: #dc2626; background-color: #fee2e2; }

        /* (Instructions Box) */
        .instructions-box { background-color: #f1f5f9; border-radius: 8px; padding: 12px; font-size: 13px; color: #475569; }
        .instructions-box code { background-color: #e2e8f0; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
        .instructions-box ol { list-style: decimal; padding-left: 20px; margin-top: 8px; }
        .instructions-box summary { font-weight: 600; cursor: pointer; }

        /* (v14) ลบ <details> and <summary> ของ Form */

    </style>
</head>
<body>

    <!-- (Toast Notification) -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 z-[6000] opacity-0 pointer-events-none transition-all duration-300 translate-y-[-20px] bg-slate-800/95 text-white px-5 py-3 rounded-full shadow-xl backdrop-blur-md flex items-center gap-3 text-sm font-medium border border-slate-700/50">
        <i id="toast-icon" class="fa-solid fa-check-circle text-emerald-400"></i>
        <span id="toast-msg">สำเร็จ</span>
    </div>

    <!-- (File Inputs) -->
    <input type="file" id="import-file-input" class="hidden" accept=".json, .txt" onchange="window.handleFileImport(event)">

    <!-- (v14) Result Modal (Simplified) -->
    <div id="result-modal-container" class="hidden">
        <div class="modal-backdrop" onclick="window.hideResultModal()"></div>
        <div class="modal-container">
            <button onclick="window.hideResultModal()" class="modal-close-btn"><i class="fa-solid fa-times"></i></button>
            
            <div class="pt-6 pb-2 px-6">
                 <h3 id="result-modal-title" class="text-xl font-bold text-slate-800">...</h3>
            </div>
            
            <!-- Retirement Card -->
            <div id="retirement-card" class="hidden bg-gradient-to-br from-brand-500 to-brand-600 text-white p-5 m-4 rounded-2xl shadow-lg shadow-sky-200">
                <h4 class="text-sm font-semibold opacity-90">อายุราชการสุทธิ (ณ วันเกษียณ)</h4>
                <p id="result-net-at-retirement" class="text-3xl font-bold my-1">...</p>
                <p id="retirement-date-result" class="text-sm">...</p>
                <p id="retirement-countdown-result" class="text-xs opacity-80 mt-2">...</p>
            </div>

            <!-- Result Card (Today) -->
            <div class="result-card m-4 mt-0 bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <!-- สรุปวันนี้ -->
                <div class="p-5 text-center">
                    <p class="text-sm font-medium text-slate-500">อายุราชการสุทธิ (วันนี้)</p>
                    <p id="result-net" class="text-3xl font-bold text-brand-600 my-1">...</p>
                    <p id="result-context-dates" class="text-xs text-slate-400">...</p>
                </div>
                <!-- (v14) รวมวันสุทธิ (ย้ายออกมา) -->
                <div class="result-row border-t border-slate-100">
                    <span class="result-label">รวม (วันสุทธิ)</span>
                    <span id="result-total-days" class="result-value">...</span>
                </div>
            </div>
            
            <!-- AI Analysis Section -->
            <div id="ai-analysis-container" class="hidden m-4 mt-0">
                <!-- AI content or spinner goes here -->
            </div>
            
            <div class="p-4 pt-2">
                <button id="btn-ai-analyze" onclick="window.handleAiAnalysis()" class="btn btn-ai w-full">
                    <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>
                    AI วิเคราะห์ผล
                </button>
            </div>

            <div class="pb-safe-bottom" style="padding-bottom: env(safe-area-inset-bottom, 1rem)"></div>
        </div>
    </div>


    <main id="app-shell">

        <!-- (Header) -->
        <header class="px-6 py-4 flex justify-between items-center sticky top-0 shadow-sm bg-white/80 z-40 backdrop-filter: blur(12px) border-b border-slate-100/80">
            <div class="flex flex-col">
                <h1 class="text-xl font-bold text-brand-600">คำนวณอายุราชการ</h1>
                <p id="header-subtitle" class="text-sm text-slate-500">v14 - Modern AI</p>
            </div>
            <div id="header-icon-container" class="w-12 h-12 bg-sky-100 rounded-full flex items-center justify-center text-sky-600 border-4 border-white shadow-md">
                <i id="header-icon" class="fa-solid fa-calculator text-xl"></i>
            </div>
        </header>

        <div id="content-area" class="flex-1 overflow-y-auto no-scrollbar pb-6">
            
            <!-- (View 1: Saved List) -->
            <section id="view-saved" class="p-6 space-y-4">
                <div class="relative">
                    <input type="text" id="input-search" oninput="window.renderSavedList()" class="form-input pl-10" placeholder="ค้นหาชื่อ...">
                    <i class="fa-solid fa-search text-slate-400 absolute top-1/2 left-3.5 -translate-y-1/2"></i>
                </div>
                <div id="saved-list-container" class="space-y-3">
                    <!-- JS populates this -->
                </div>
            </section>
            
            <!-- (View 2: Calculator / Edit Form - v14) -->
            <section id="view-calc" class="hidden p-6 space-y-4">
                
                <!-- (v14) ลบ <form> ออก และเพิ่มปุ่มคำนวณที่ควบคุมโดย JS -->
                <div id="calc-form-container" class="space-y-4">
                    
                    <input type="hidden" id="form-id">
                    <input type="hidden" id="form-start-iso">
                    <input type="hidden" id="form-birth-iso">
                    
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                        <h3 id="form-title" class="text-lg font-bold text-slate-800 mb-4">เพิ่มรายการใหม่</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="form-name" class="form-label flex items-center gap-2">
                                    <i class="fa-solid fa-user fa-fw text-slate-400"></i>
                                    <span>ชื่อ-สกุล (สำหรับบันทึก)</span>
                                </label>
                                <input type="text" id="form-name" class="form-input" placeholder="เช่น นายสมชาย ใจดี" required>
                            </div>
                            
                            <!-- AI-First Input -->
                            <div>
                                <label for="form-start-smart" class="form-label flex items-center gap-2">
                                    <i class="fa-solid fa-calendar-check fa-fw text-slate-400"></i>
                                    <span>วันที่บรรจุ</span>
                                </label>
                                <div class="smart-date-wrapper">
                                    <input type="text" id="form-start-smart" class="form-input smart-date" placeholder="พิมพ์วันที่ (เช่น 10 กค 34 หรือ 15/5/1991)">
                                    <span id="form-start-spinner" class="smart-date-spinner hidden">
                                        <i class="fa-solid fa-spinner"></i>
                                    </span>
                                </div>
                            </div>
                            
                            <!-- AI-First Input -->
                            <div>
                                <label for="form-birth-smart" class="form-label flex items-center gap-2">
                                    <i class="fa-solid fa-cake-candles fa-fw text-slate-400"></i>
                                    <span>วันเกิด (สำหรับคำนวณเกษียณ)</span>
                                </label>
                                <div class="smart-date-wrapper">
                                    <input type="text" id="form-birth-smart" class="form-input smart-date" placeholder="พิมพ์วันที่...">
                                    <span id="form-birth-spinner" class="smart-date-spinner hidden">
                                        <i class="fa-solid fa-spinner"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- (v14) ลบ <details> วันลา และ ทวีคูณ ออก -->

                    <!-- (v14) ปุ่มคำนวณและบันทึก (ถูกซ่อนไว้) -->
                    <div class="pt-2">
                        <button id="btn-calc-save" type="button" onclick="window.calculateAndShow()" class="btn btn-calc w-full hidden">
                            <i class="fa-solid fa-calculator mr-2"></i>
                            คำนวณและบันทึก
                        </button>
                    </div>
                </div>
            </section>
            
            <!-- (View 3: Manage / Settings - v14) -->
            <section id="view-manage" class="hidden p-6 space-y-6">
                
                <!-- (v11) AI Proxy Settings -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-800">AI Proxy Settings (v14)</h3>
                        <i class="fa-solid fa-server text-2xl text-ai-500"></i>
                    </div>
                    <p class="text-sm text-slate-600 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <i class="fa-solid fa-check-circle mr-1 text-blue-600"></i>
                        AI Proxy URL ถูกฝังในโค้ด (Hardcoded) แล้ว
                    </p>
                    <p class="text-xs text-slate-500 mt-3">
                        หากต้องการเปลี่ยน URL, กรุณาแก้ไขไฟล์ `.html` โดยตรง
                    </p>
                </div>

                <!-- Google Sheet Sync -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-800">Data Sync Settings</h3>
                        <i class="fa-brands fa-google-drive text-2xl text-google-500"></i>
                    </div>
                    <div>
                        <label for="input-apps-script-url" class="form-label">Google Apps Script URL (Data Sync)</label>
                        <input type="url" id="input-apps-script-url" class="form-input" placeholder="https://script.google.com/macros/s/..." oninput="window.saveAppsScriptUrl(this.value)">
                    </div>
                    
                    <!-- (Code.gs) -->
                    <details class="mt-4">
                         <summary class="instructions-box summary">
                            <i class="fa-solid fa-code"></i> โค้ดสำหรับ Data Sync (v14 - Simplified)
                        </summary>
                        <div class="instructions-box mt-2">
                            <pre class="overflow-x-auto p-2 bg-slate-700 text-white rounded-md text-xs"><code>function doPost(e) {
  try {
    var sheetName = "ServiceYears"; // ตั้งชื่อ Sheet
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName(sheetName);
    if (!sheet) {
      sheet = ss.insertSheet(sheetName);
    }
    
    var data = JSON.parse(e.postData.contents);
    
    if (data.length === 0) {
      sheet.clearContents();
      sheet.getRange(1, 1).setValue("No data synced.");
      return ContentService.createTextOutput(JSON.stringify({ status: "success", message: "Data was empty, sheet cleared." })).setMimeType(ContentService.MimeType.JSON);
    }

    // (v14) ลบ Logic การแปลง {y,m,d} (เพราะเราลบ field นั้นทิ้ง)
    var headers = Object.keys(data[0]);
    var values = data.map(function(row) {
      return headers.map(function(header) {
        return row[header] !== undefined ? row[header] : "";
      });
    });

    sheet.clearContents();
    
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight("bold");
    
    if (values.length > 0) {
      sheet.getRange(2, 1, values.length, headers.length).setValues(values);
      sheet.autoResizeColumns(1, headers.length);
    }
    
    return ContentService.createTextOutput(JSON.stringify({ status: "success", rows_synced: values.length, sheetName: sheetName })).setMimeType(ContentService.MimeType.JSON);
  
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ status: "error", message: error.message })).setMimeType(ContentService.MimeType.JSON);
  }
}</code></pre>
                        </div>
                    </details>
                </div>
                
                <!-- (Import/Export) -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">นำเข้า / ส่งออก ข้อมูล</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="window.exportBackup()" class="btn btn-secondary">
                            <i class="fa-solid fa-download mr-2"></i> บันทึกลงเครื่อง
                        </button>
                        <button onclick="window.triggerImport()" class="btn btn-secondary">
                            <i class="fa-solid fa-upload mr-2"></i> นำเข้าจากเครื่อง
                        </button>
                    </div>
                </div>

                <!-- (JSON Data) -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">จัดการข้อมูล (JSON)</h3>
                    <div>
                        <label for="input-data-json" class="form-label">ข้อมูลที่บันทึกไว้ (JSON Array)</label>
                        <textarea id="input-data-json" class="form-textarea" rows="8"></textarea>
                    </div>
                    <button onclick="window.saveDataFromJson()" class="btn btn-secondary w-full mt-4">
                        <i class="fa-solid fa-save mr-2"></i> บันทึกข้อมูล
                    </button>
                </div>
            </section>

        </div>

        <!-- (Bottom Nav - v4) -->
        <nav id="bottom-nav" class="bottom-nav shrink-0">
            <div id="nav-saved" class="nav-item active" onclick="window.switchView('view-saved')">
                <i class="fa-solid fa-list-check"></i>
                <span>รายการ</span>
            </div>
            <div id="nav-calc" class="nav-item" onclick="window.switchView('view-calc')">
                <i class="fa-solid fa-plus-circle"></i>
                <span>เพิ่ม/แก้ไข</span>
            </div>
            <div id="nav-manage" class="nav-item" onclick="window.switchView('view-manage')">
                <i class="fa-solid fa-sliders"></i>
                <span>ตั้งค่า</span>
            </div>
        </nav>
    </main>

    <script type="module">
        
        // --- CONSTANTS ---
        const DAYS_PER_MONTH = 30;
        const DAYS_PER_YEAR = 365;
        const LOCAL_STORAGE_KEY = 'service_year_data_v14'; // (v14)
        const GAS_URL_KEY = 'service_year_gas_url_v14'; // (v14)
        
        const AI_PROXY_URL = "https://script.google.com/macros/s/AKfycbyGzNyiu6bHyb5BU8ay8Myt6bnPFldJgo_WIcm7WUVLyDa-BGn9oKkFbb8scMbzJy7W/exec";

        const THAI_MONTHS = [
            "ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", 
            "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."
        ];
        
        // --- STATE & DOM ---
        let state = {
            savedCalculations: [],
            currentView: 'view-saved',
            currentModalData: null, 
            // (v14) สถานะความถูกต้องของฟอร์ม
            formState: {
                name: false,
                startDate: false,
                birthDate: false
            }
        };
        
        const dom = {
            views: { 
                saved: document.getElementById('view-saved'), 
                calc: document.getElementById('view-calc'), 
                manage: document.getElementById('view-manage') 
            },
            nav: { 
                saved: document.getElementById('nav-saved'), 
                calc: document.getElementById('nav-calc'), 
                manage: document.getElementById('nav-manage') 
            },
            headerSubtitle: document.getElementById('header-subtitle'),
            headerIcon: document.getElementById('header-icon'),
            headerIconContainer: document.getElementById('header-icon-container'),
            
            // View Calc (Form)
            calcFormContainer: document.getElementById('calc-form-container'), // (v14)
            formTitle: document.getElementById('form-title'),
            formId: document.getElementById('form-id'),
            formName: document.getElementById('form-name'),
            // (v14) ลบ formLeave, formMult
            btnCalcSave: document.getElementById('btn-calc-save'), // (v14)

            // (v12) AI-First Date Pickers
            formStartSmart: document.getElementById('form-start-smart'),
            formStartSpinner: document.getElementById('form-start-spinner'), 
            formStartISO: document.getElementById('form-start-iso'), 
            formBirthSmart: document.getElementById('form-birth-smart'),
            formBirthSpinner: document.getElementById('form-birth-spinner'), 
            formBirthISO: document.getElementById('form-birth-iso'), 

            // View Saved
            inputSearch: document.getElementById('input-search'),
            savedListContainer: document.getElementById('saved-list-container'),
            
            // View Manage
            inputAppsScriptUrl: document.getElementById('input-apps-script-url'),
            importFileInput: document.getElementById('import-file-input'),
            inputDataJson: document.getElementById('input-data-json'),
            
            // Result Modal (v14)
            resultModalContainer: document.getElementById('result-modal-container'),
            resultModalTitle: document.getElementById('result-modal-title'),
            retirementCard: document.getElementById('retirement-card'),
            retirementDateResult: document.getElementById('retirement-date-result'),
            retirementCountdownResult: document.getElementById('retirement-countdown-result'),
            resultNetAtRetirement: document.getElementById('result-net-at-retirement'),
            resultNet: document.getElementById('result-net'),
            resultContextDates: document.getElementById('result-context-dates'),
            // (v14) ลบ Row (ดิบ, ลา, ทวีคูณ)
            resultTotalDays: document.getElementById('result-total-days'), 
            btnAiAnalyze: document.getElementById('btn-ai-analyze'), 
            aiAnalysisContainer: document.getElementById('ai-analysis-container'), 

            // Toast
            toast: document.getElementById('toast'),
            toastIcon: document.getElementById('toast-icon'),
            toastMsg: document.getElementById('toast-msg'),
        };

        // --- INITIALIZATION ---
        function initApp() {
            loadCalculations();
            loadAppsScriptUrl();
            switchView('view-saved');
            
            // (v14) Listeners สำหรับ Form Validation
            dom.formName.addEventListener('input', (e) => {
                state.formState.name = e.target.value.trim().length > 0;
                checkFormValidity();
            });
            dom.formStartSmart.addEventListener('blur', (e) => handleSmartDateInput(e.target, dom.formStartSpinner, dom.formStartISO, 'startDate'));
            dom.formBirthSmart.addEventListener('blur', (e) => handleSmartDateInput(e.target, dom.formBirthSpinner, dom.formBirthISO, 'birthDate'));
            // (v14) Listener สำหรับการล้างค่า
            dom.formStartSmart.addEventListener('input', (e) => {
                if(e.target.value.trim() === '') {
                    dom.formStartISO.value = '';
                    state.formState.startDate = false;
                    checkFormValidity();
                }
            });
            dom.formBirthSmart.addEventListener('input', (e) => {
                if(e.target.value.trim() === '') {
                    dom.formBirthISO.value = '';
                    state.formState.birthDate = false;
                    checkFormValidity();
                }
            });
        }

        // --- NAVIGATION & UTILS ---
        
        function switchView(id) {
            state.currentView = id;

            Object.values(dom.views).forEach(el => el.classList.add('hidden'));
            const viewId = id.split('-')[1]; 
            if (dom.views[viewId]) dom.views[viewId].classList.remove('hidden');
            
            Object.values(dom.nav).forEach(el => el.classList.remove('active'));
            if (dom.nav[viewId]) dom.nav[viewId].classList.add('active');
            
            if (id === 'view-calc' && !dom.formId.value) {
                handleCreateNew();
            }
            if (id !== 'view-calc') {
                dom.formId.value = '';
            }
            
            updateHeader(id);
            
            switch(id) {
                case 'view-saved': renderSavedList(); break;
                case 'view-calc': break; 
                case 'view-manage': renderManage(); break;
            }
        }

        function updateHeader(id) {
            let subtitle = "รายการที่บันทึกไว้";
            let iconClass = "fa-solid fa-list-check";
            
            dom.headerIconContainer.classList.add('hidden');

            switch(id) {
                case 'view-calc':
                    subtitle = dom.formId.value ? "แก้ไขรายการ" : "เพิ่มรายการใหม่";
                    iconClass = dom.formId.value ? "fa-solid fa-pencil" : "fa-solid fa-plus-circle";
                    break;
                case 'view-manage':
                    subtitle = "ตั้งค่า & จัดการข้อมูล";
                    iconClass = "fa-solid fa-sliders";
                    dom.headerIconContainer.classList.remove('hidden'); 
                    break;
                case 'view-saved':
                default:
                    subtitle = "รายการที่บันทึกไว้";
                    iconClass = "fa-solid fa-list-check";
                    dom.headerIconContainer.classList.remove('hidden'); 
                    break;
            }
            
            dom.headerSubtitle.textContent = subtitle;
            dom.headerIcon.className = `${iconClass} text-xl`;
        }

        function showToast(msg, type='success') {
            dom.toastMsg.textContent = msg;
            dom.toastIcon.className = type==='success' ? "fa-solid fa-check-circle text-emerald-400" : "fa-solid fa-circle-exclamation text-rose-400";
            dom.toast.classList.remove('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => dom.toast.classList.add('opacity-0', 'translate-y-[-20px]'), 3000);
        }

        // --- DATA PERSISTENCE (LocalStorage) ---
        
        function loadCalculations() {
            const data = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (data) {
                try { 
                    state.savedCalculations = JSON.parse(data); 
                    // (v14) ลบ Logic (leave/mult)
                    state.savedCalculations.forEach(item => {
                        if (!item.birthDate) item.birthDate = null;
                    });
                } catch (e) { state.savedCalculations = []; }
            } else {
                state.savedCalculations = [];
            }
        }
        
        function saveCalculationsToStorage() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state.savedCalculations));
            } catch (e) { showToast('ไม่สามารถบันทึกข้อมูลได้ (อาจจะเต็ม)', 'error'); }
        }

        function loadAppsScriptUrl() {
            const url = localStorage.getItem(GAS_URL_KEY);
            if (url) dom.inputAppsScriptUrl.value = url;
        }
        
        
        // --- (v14) SMART DATE (AI PROXY) ---
        
        /**
         * (v14) อัปเดต handleSmartDateInput (AI Proxy)
         */
        async function handleSmartDateInput(smartInput, spinnerEl, isoHiddenInput, stateKey) {
            const text = smartInput.value.trim();
            if (!text) {
                isoHiddenInput.value = '';
                state.formState[stateKey] = false;
                checkFormValidity();
                return;
            }
            
            const aiProxyUrl = AI_PROXY_URL; 
            
            if (!aiProxyUrl || aiProxyUrl.includes("!!!_PASTE_")) {
                showToast('ยังไม่ได้ตั้งค่า AI Proxy URL (ในโค้ด v11)', 'error');
                return;
            }

            spinnerEl.classList.remove('hidden'); 
            smartInput.disabled = true;
            
            try {
                const response = await fetch(aiProxyUrl, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'parse_date', text: text })
                });
                
                const result = await response.json();

                if (result.status === 'success' && result.type === 'date' && result.isoDate) {
                    isoHiddenInput.value = result.isoDate;
                    smartInput.value = formatISODateForDisplay(result.isoDate);
                    state.formState[stateKey] = true; // (v14)
                } else if (result.status === 'success' && result.type === 'date' && !result.isoDate) {
                    showToast(`AI ไม่เข้าใจรูปแบบวันที่: "${text}"`, 'error');
                    isoHiddenInput.value = ''; 
                    state.formState[stateKey] = false; // (v14)
                } else {
                    throw new Error(result.message || "AI Proxy Error (Invalid Response Type)");
                }

            } catch (error) {
                console.error("AI Proxy Fetch Error:", error);
                showToast(`AI Proxy ล้มเหลว: ${error.message}`, 'error');
                state.formState[stateKey] = false; // (v14)
            } finally {
                spinnerEl.classList.add('hidden'); 
                smartInput.disabled = false;
                checkFormValidity(); // (v14)
            }
        }
        
        
        // --- (v12) DATE PICKER HELPER FUNCTIONS ---
        
        function formatISODateForDisplay(isoString) {
            if (!isoString) return "";
            try {
                const date = new Date(isoString + "T00:00:00Z"); 
                const d = date.getUTCDate();
                const m = date.getUTCMonth(); // 0-11
                const yBE = date.getUTCFullYear() + 543;
                
                return `${d} ${THAI_MONTHS[m]} ${yBE}`; // เช่น "10 ก.ค. 2534"
            } catch (e) {
                return ""; 
            }
        }

        // --- CORE CALCULATION LOGIC ---
        // (v14) ลบ ymdToDays, daysToYmd เพราะย้ายไป AI Proxy
        // (v14) อัปเดต: ไม่ได้ย้ายไป AI Proxy แต่ย้ายไป AI Analysis
        // (v14) อัปเดต 2: ตรรกะ ymdToDays/daysToYmd ยังต้องใช้สำหรับ *การคำนวณ* (ไม่ใช่การ Parse)
        // ดังนั้น นำกลับมา
        
        function calculateDifference(d1, d2) {
            if (!d1 || !d2 || d2 < d1) return { y: 0, m: 0, d: 0 };
            let y = d2.getFullYear() - d1.getFullYear();
            let m = d2.getMonth() - d1.getMonth();
            let d = d2.getDate() - d1.getDate();
            if (d < 0) {
                m--;
                let daysInLastMonth = new Date(d2.getFullYear(), d2.getMonth(), 0).getDate();
                d += daysInLastMonth;
            }
            if (m < 0) { y--; m += 12; }
            return { y, m, d };
        }
        
        // (v14) ยังต้องใช้ฟังก์ชันนี้
        function ymdToDays(ymd) {
            if (!ymd) return 0;
            // (v14) ทำให้ง่ายขึ้น (เพราะไม่มี leave/mult)
            return (ymd.y * DAYS_PER_YEAR) + (ymd.m * DAYS_PER_MONTH) + ymd.d;
        }

        // (v14) ยังต้องใช้ฟังก์ชันนี้
        function daysToYmd(totalDays) {
            totalDays = Math.max(0, totalDays); 
            const y = Math.floor(totalDays / DAYS_PER_YEAR);
            const remainder = totalDays % DAYS_PER_YEAR;
            const m = Math.floor(remainder / DAYS_PER_MONTH);
            const d = Math.round(remainder % DAYS_PER_MONTH); 
            if (d === 30) {
                const newM = m + 1;
                const newY = y + Math.floor(newM / 12);
                return { y: newY, m: newM % 12, d: 0 };
            }
            return { y, m, d };
        }
        
        function formatYmd(ymd) {
            if (!ymd) return "N/A";
            return `${ymd.y} ปี ${ymd.m} เดือน ${ymd.d} วัน`;
        }
        function getRetirementDate(birthDateStr) {
            if (!birthDateStr) return null;
            try {
                const birthDate = new Date(birthDateStr + "T00:00:00Z");
                let retirementYear = birthDate.getUTCFullYear() + 60;
                if (birthDate.getUTCMonth() >= 9) { // 9=ต.ค.
                     retirementYear += 1;
                }
                return new Date(Date.UTC(retirementYear, 8, 30)); 
            } catch (e) { return null; }
        }


        // --- EVENT HANDLERS (CRUD) ---

        /**
         * (v14) ใหม่: ตรวจสอบฟอร์มเพื่อแสดงปุ่มบันทึก
         */
        function checkFormValidity() {
            const { name, startDate, birthDate } = state.formState;
            // (v14) BirthDate เป็น Optional (ถ้าไม่กรอก ก็ไม่แสดงผลเกษียณ)
            if (name && startDate) {
                dom.btnCalcSave.classList.remove('hidden');
            } else {
                dom.btnCalcSave.classList.add('hidden');
            }
        }
        
        /**
         * (v14) อัปเดต handleCreateNew
         */
        function handleCreateNew() {
            // (v14) ลบ .reset() เพราะเราจะเคลียร์เอง
            dom.formId.value = '';
            dom.formName.value = '';
            
            dom.formStartSmart.value = '';
            dom.formBirthSmart.value = '';
            dom.formStartISO.value = '';
            dom.formBirthISO.value = '';
            
            // (v14) รีเซ็ต state
            state.formState.name = false;
            state.formState.startDate = false;
            state.formState.birthDate = false;
            checkFormValidity(); // (v14) ซ่อนปุ่ม

            dom.formTitle.textContent = "เพิ่มรายการใหม่";
            dom.btnCalcSave.textContent = "คำนวณและบันทึก";
            updateHeader('view-calc');
        }

        /**
         * (v14) อัปเดต handleSave
         * @param {Event | null} event - (v14) อาจเป็น null
         * @param {boolean} [shouldSwitchView=true] - (v14) พารามิเตอร์ใหม่
         * @returns {string | null} - ID ของรายการที่บันทึก
         */
        function handleSave(event, shouldSwitchView = true) {
            if(event) event.preventDefault(); // (v14) ป้องกัน submit ถ้าเรียกจาก form (ซึ่งตอนนี้ไม่)
            
            const id = dom.formId.value || `calc_${Date.now()}`;
            const name = dom.formName.value;
            
            const startDateISO = dom.formStartISO.value || null;
            const birthDateISO = dom.formBirthISO.value || null;

            if (!name || !startDateISO) {
                showToast('ข้อมูลไม่ครบ (ชื่อ หรือ วันที่บรรจุ)', 'error');
                return null;
            }

            const record = {
                id: id,
                name: name,
                startDate: startDateISO, 
                birthDate: birthDateISO, 
                // (v14) ลบ leave และ mult
            };
            
            const isEditing = !!dom.formId.value;
            
            if (isEditing) {
                state.savedCalculations = state.savedCalculations.map(item => 
                    item.id === id ? record : item
                );
            } else {
                state.savedCalculations.push(record);
            }

            saveCalculationsToStorage();
            triggerAutoSync();
            
            if (shouldSwitchView) {
                showToast(isEditing ? `อัปเดต '${record.name}' สำเร็จ` : `บันทึก '${record.name}' สำเร็จ`);
                dom.formId.value = ''; 
                switchView('view-saved'); 
            }
            
            return id; // (v14) คืนค่า ID
        }
        
        /**
         * (v14) ใหม่: ฟังก์ชันสำหรับ Workflow ใหม่
         */
        function calculateAndShow() {
            // 1. บันทึก (โดยไม่สลับหน้า)
            const savedId = handleSave(null, false);
            
            if (savedId) {
                // 2. แสดง Modal ผลลัพธ์ (ตามที่คุณขอ)
                showResultModal(savedId);
                
                // 3. (v14) ถ้าเป็นการ "เพิ่มใหม่" (ไม่ใช่แก้ไข) ให้เคลียร์ฟอร์ม
                if (!dom.formId.value) {
                    handleCreateNew();
                }
            }
        }

        /**
         * (v14) อัปเดต handleEdit
         */
        function handleEdit(id) {
            const item = state.savedCalculations.find(i => i.id === id);
            if (!item) return;

            dom.formId.value = item.id;
            dom.formName.value = item.name;
            
            dom.formStartISO.value = item.startDate || '';
            dom.formBirthISO.value = item.birthDate || '';
            
            dom.formStartSmart.value = formatISODateForDisplay(item.startDate);
            dom.formBirthSmart.value = formatISODateForDisplay(item.birthDate);
            
            // (v14) ลบ leave/mult
            
            // (v14) ตั้งค่า state สำหรับปุ่ม
            state.formState.name = true;
            state.formState.startDate = !!item.startDate;
            state.formState.birthDate = !!item.birthDate;
            checkFormValidity(); // (v14) แสดงปุ่ม
            
            dom.formTitle.textContent = "แก้ไขรายการ";
            dom.btnCalcSave.textContent = "อัปเดตและคำนวณ";
            
            switchView('view-calc');
        }

        function handleDelete(id, event) {
            event.stopPropagation();
            const item = state.savedCalculations.find(i => i.id === id);
            if (!item) return;

            const confirmed = true; 
            
            if (confirmed) {
                state.savedCalculations = state.savedCalculations.filter(i => i.id !== id);
                saveCalculationsToStorage();
                triggerAutoSync();
                renderSavedList(); 
                showToast(`ลบรายการ '${item.name}' แล้ว`, 'success');
            }
        }

        function renderSavedList() {
            const searchTerm = dom.inputSearch.value.toLowerCase();
            const list = state.savedCalculations.filter(item => 
                item.name.toLowerCase().includes(searchTerm)
            );
            
            const d2 = new Date(); 
            const d2_formatted = d2.toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: 'numeric' });

            if (list.length === 0) {
                dom.savedListContainer.innerHTML = `
                <div class="text-center text-slate-500 mt-8 p-6 bg-white rounded-2xl">
                    <i class="fa-solid fa-folder-open text-4xl text-slate-300 mb-4"></i>
                    <p class="font-semibold">ไม่พบรายการที่บันทึกไว้</p>
                    <p class="text-sm">กดแท็บ <i class="fa-solid fa-plus-circle"></i> เพื่อเพิ่มรายการใหม่</p>
                </div>`;
                return;
            }
            
            list.sort((a, b) => (a.name || "").localeCompare(b.name));

            dom.savedListContainer.innerHTML = list.map(item => {
                
                if (!item.startDate) {
                    return `<!-- Invalid item: ${item.id} -->`;
                }
                const d1 = new Date(item.startDate);
                const rawYmd = calculateDifference(d1, d2);
                const rawDays = ymdToDays(rawYmd);
                // (v14) ลบ leave/mult
                const netDays = rawDays;
                const netYmd = daysToYmd(netDays);

                return `
                <div class="saved-item-card animate-fade-in">
                    <div class="saved-item-icon">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <div class="saved-item-content cursor-pointer" onclick="window.showResultModal('${item.id}')">
                        <h4>${item.name}</h4>
                        <p class="font-semibold text-brand-600">${formatYmd(netYmd)}</p>
                        <p class="text-xs text-slate-400">คำนวณถึง: ${d2_formatted}</p>
                    </div>
                    <div class="saved-item-actions">
                        <button onclick="window.handleEdit('${item.id}')" class="saved-item-btn">
                            <i class="fa-solid fa-pencil text-xs"></i>
                        </button>
                        <button onclick="window.handleDelete('${item.id}', event)" class="saved-item-btn danger">
                            <i class="fa-solid fa-trash text-xs"></i>
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        /**
         * (v14) อัปเดต showResultModal
         */
        function showResultModal(id) {
            const item = state.savedCalculations.find(i => i.id === id);
            if (!item) return;
            
            dom.aiAnalysisContainer.classList.add('hidden');
            dom.aiAnalysisContainer.innerHTML = '';

            const d1 = new Date(item.startDate);
            const d2 = new Date(); 
            
            // (v14) ลบ leave/mult
            const retirementDateObj = getRetirementDate(item.birthDate);
            
            let netYmdAtRetirement = null;
            let countdownYmd = null;
            
            dom.retirementCard.classList.add('hidden');

            if (retirementDateObj) {
                const rawYmdAtRetirement = calculateDifference(d1, retirementDateObj);
                // (v14) ลบ leave/mult
                netYmdAtRetirement = daysToYmd(ymdToDays(rawYmdAtRetirement));
                
                dom.resultNetAtRetirement.textContent = formatYmd(netYmdAtRetirement);
                
                dom.retirementDateResult.textContent = `ณ วันที่ ${retirementDateObj.toLocaleDateString('th-TH', {
                    day: 'numeric', month: 'long', year: 'numeric'
                })}`;
                
                if (retirementDateObj > d2) { 
                    countdownYmd = calculateDifference(d2, retirementDateObj);
                    dom.retirementCountdownResult.textContent = `(เหลือเวลาอีก ${formatYmd(countdownYmd)})`;
                } else {
                    dom.retirementCountdownResult.textContent = "(เกษียณอายุแล้ว)";
                }
                dom.retirementCard.classList.remove('hidden');
            }

            const rawYmd = calculateDifference(d1, d2);
            // (v14) ลบ leave/mult
            const netDays = ymdToDays(rawYmd);
            const netYmd = daysToYmd(netDays);
            
            dom.resultModalTitle.textContent = item.name;
            dom.resultNet.textContent = formatYmd(netYmd);
            dom.resultContextDates.textContent = `(คำนวณจาก ${d1.toLocaleDateString('th-TH', { dateStyle: 'short' })} ถึง ${d2.toLocaleDateString('th-TH', { dateStyle: 'short' })})`;
            dom.resultTotalDays.textContent = netDays.toLocaleString() + ' วัน';
            
            // (v14) ลบ Logic การซ่อน/แสดง แถว
            
            // (v14) บันทึกข้อมูลสำหรับ AI (Simplified)
            state.currentModalData = {
                name: item.name,
                netToday: netYmd,
                netAtRetirement: netYmdAtRetirement,
                countdown: countdownYmd,
            };
            
            dom.resultModalContainer.classList.remove('hidden');
        }
        
        function hideResultModal() {
            dom.resultModalContainer.classList.add('hidden');
            state.currentModalData = null; 
        }

        /**
         * (v14) อัปเดต AI Analysis (ลบ leave/mult)
         */
        async function handleAiAnalysis() {
            if (!state.currentModalData) return;
            
            const aiProxyUrl = AI_PROXY_URL;
            if (!aiProxyUrl || aiProxyUrl.includes("!!!_PASTE_")) {
                showToast('ยังไม่ได้ตั้งค่า AI Proxy URL (ในโค้ด v11)', 'error');
                return;
            }
            
            const btn = dom.btnAiAnalyze;
            const container = dom.aiAnalysisContainer;
            
            btn.disabled = true;
            container.innerHTML = `<div class="ai-spinner"><i class="fa-solid fa-spinner"></i><span>AI กำลังวิเคราะห์...</span></div>`;
            container.classList.remove('hidden');
            
            try {
                const response = await fetch(aiProxyUrl, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain' },
                    // (v14) ส่ง Payload ที่ Simplified
                    body: JSON.stringify({ 
                        action: 'analyze_results', 
                        payload: state.currentModalData 
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success' && result.type === 'analysis' && result.analysisText) {
                    container.innerHTML = `<p>${result.analysisText}</p>`;
                } else {
                    throw new Error(result.message || "AI Proxy Error (Invalid Response Type)");
                }
                
            } catch (error) {
                console.error("AI Analysis Fetch Error:", error);
                container.innerHTML = `<p class="text-danger-600">AI วิเคราะห์ล้มเหลว: ${error.message}</p>`;
            } finally {
                btn.disabled = false;
            }
        }
        
        function renderManage() {
            dom.inputDataJson.value = JSON.stringify(state.savedCalculations, null, 2);
            loadAppsScriptUrl();
        }

        // --- MANAGE VIEW FUNCTIONS ---

        function saveDataFromJson() {
            try {
                const newData = JSON.parse(dom.inputDataJson.value);
                if (Array.isArray(newData)) {
                    state.savedCalculations = newData;
                    saveCalculationsToStorage();
                    showToast('บันทึกข้อมูล JSON สำเร็จ');
                    triggerAutoSync();
                    switchView('view-saved');
                } else { showToast('รูปแบบข้อมูลไม่ถูกต้อง (ต้องเป็น Array)', 'error'); }
            } catch (e) { showToast(`เกิดข้อผิดพลาด: ${e.message}`, 'error'); }
        }

        function exportBackup() {
            const data = JSON.stringify(state.savedCalculations, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `service_year_backup_${new Date().toLocaleDateString('sv-SE')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('กำลังดาวน์โหลดไฟล์สำรองข้อมูล');
        }
        
        function triggerImport() { dom.importFileInput.click(); }
        
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (Array.isArray(importedData)) {
                            state.savedCalculations = importedData;
                        } else {
                            throw new Error('ไฟล์ไม่ถูกต้อง (ต้องเป็น Array)');
                        }

                        saveCalculationsToStorage();
                        renderManage(); 
                        triggerAutoSync();
                        switchView('view-saved'); 
                    } catch (err) { showToast(`เกิดข้อผิดพลาด: ${err.message}`, 'error'); }
                };
                reader.readAsText(file);
            }
            event.target.value = null; 
        }

        // --- GOOGLE SHEET SYNC (Auto) ---
        
        async function triggerAutoSync() {
            const url = dom.inputAppsScriptUrl.value;
            if (!url) return; 

            console.log("Auto-syncing to Google Sheet in background...");

            try {
                // (v14) Payload ที่ส่งไป Sheet จะไม่มี leave/mult แล้ว
                const payload = JSON.stringify(state.savedCalculations);
                const response = await fetch(url, {
                    method: 'POST', mode: 'cors', 
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: payload
                });
                const result = await response.json();
                if (result.status === 'success') {
                    console.log(`Auto-sync successful: ${result.rows_synced} rows.`);
                } else {
                    throw new Error(result.message || "Unknown error from Apps Script");
                }
            } catch (error) {
                console.error("GSheet Auto-Sync Error:", error);
                showToast(`Auto-sync ล้มเหลว: ${error.message}`, 'error');
            }
        }


        // --- Window Attachments ---
        window.switchView = switchView;
        window.handleSave = handleSave;
        window.calculateAndShow = calculateAndShow; // (v14)
        window.handleEdit = handleEdit;
        window.handleDelete = handleDelete;
        window.renderSavedList = renderSavedList;
        window.showResultModal = showResultModal; 
        window.hideResultModal = hideResultModal; 
        window.saveAppsScriptUrl = (v) => { localStorage.setItem(GAS_URL_KEY, v); };
        window.saveDataFromJson = saveDataFromJson;
        window.exportBackup = exportBackup;
        window.triggerImport = triggerImport;
        window.handleFileImport = handleFileImport;
        window.triggerAutoSync = triggerAutoSync;
        window.handleCreateNew = handleCreateNew;
        window.handleSmartDateInput = handleSmartDateInput; 
        window.handleAiAnalysis = handleAiAnalysis; 

        // --- Start App ---
        initApp();
    </script>
</body>
</html>
